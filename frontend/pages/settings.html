<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - FMS</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    <style>
        .settings-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .settings-card h3 {
            color: #333;
            font-size: 1.3rem;
            margin-bottom: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-card > p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .nav-tabs {
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 25px;
        }

        .nav-tabs .nav-link {
            color: #666;
            border: none;
            border-bottom: 3px solid transparent;
            padding: 12px 20px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .nav-tabs .nav-link:hover {
            color: #667eea;
            border-color: transparent;
        }

        .nav-tabs .nav-link.active {
            color: #667eea;
            background: transparent;
            border-bottom-color: #667eea;
        }

        .avatar-section {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid #667eea;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #667eea;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-info h5 {
            margin: 0;
            font-size: 15px;
            color: #333;
            font-weight: 500;
        }

        .setting-info p {
            margin: 5px 0 0 0;
            font-size: 13px;
            color: #999;
        }

        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .info-box strong {
            display: block;
            color: #666;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .info-box span {
            color: #333;
            font-size: 1rem;
        }

        .danger-zone {
            background: #fff5f5;
            border: 2px solid #ff4444;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .danger-zone h4 {
            color: #d32f2f;
            margin-bottom: 10px;
        }

        .btn-danger-action {
            background: #d32f2f;
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-danger-action:hover {
            background: #b71c1c;
            transform: translateY(-2px);
        }

        .navbar-user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 8px;
            object-fit: cover;
            border: 2px solid #667eea;
        }

        /* Dark Theme Styles */
        body.dark-theme {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }

        body.dark-theme .settings-card,
        body.dark-theme .profile-card {
            background: #2d2d2d;
            color: #e0e0e0;
        }

        body.dark-theme .settings-card h3,
        body.dark-theme .settings-card h4,
        body.dark-theme .info-label {
            color: #e0e0e0;
        }

        body.dark-theme .settings-card > p,
        body.dark-theme .info-value {
            color: #b0b0b0;
        }

        body.dark-theme .form-control,
        body.dark-theme .form-select {
            background-color: #3a3a3a;
            color: #e0e0e0;
            border-color: #4a4a4a;
        }

        body.dark-theme .navbar {
            background-color: #2d2d2d !important;
            border-bottom-color: #4a4a4a !important;
        }

        body.dark-theme #sidebar-wrapper {
            background: linear-gradient(135deg, #4a5568 0%, #553c7e 100%) !important;
        }

        body.dark-theme .info-box {
            background: #3a3a3a;
            border-left-color: #667eea;
        }

        body.dark-theme .activity-item {
            background: #3a3a3a;
        }

        body.dark-theme .setting-row {
            border-bottom-color: #3a3a3a;
        }

        body.dark-theme .nav-tabs {
            border-bottom-color: #4a4a4a;
        }

        body.dark-theme .nav-tabs .nav-link {
            color: #b0b0b0;
        }

        body.dark-theme .nav-tabs .nav-link.active {
            color: #667eea;
            background: transparent;
        }
    </style>
</head>
<body>
    <div class="d-flex" id="wrapper">
        <!-- Sidebar -->
        <div class="bg-primary text-white" id="sidebar-wrapper">
            <div class="sidebar-heading text-center py-4">
                <h3><i class="fas fa-folder"></i> FMS</h3>
                <small>File Management System</small>
            </div>
            <div class="list-group list-group-flush">
                <a href="dashboard.html" class="list-group-item list-group-item-action bg-primary text-white">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="create-file.html" class="list-group-item list-group-item-action bg-primary text-white">
                    <i class="fas fa-plus-circle"></i> Create File
                </a>
                <a href="file-list.html" class="list-group-item list-group-item-action bg-primary text-white">
                    <i class="fas fa-list"></i> File List
                </a>
                <a href="scan-file.html" class="list-group-item list-group-item-action bg-primary text-white">
                    <i class="fas fa-qrcode"></i> Scan File
                </a>
                <a href="movement-history.html" class="list-group-item list-group-item-action bg-primary text-white">
                    <i class="fas fa-history"></i> Movement History
                </a>
                <a href="reports.html" class="list-group-item list-group-item-action bg-primary text-white">
                    <i class="fas fa-chart-bar"></i> Reports
                </a>
                <a href="old-reports.html" class="list-group-item list-group-item-action bg-primary text-white">
                    <i class="fas fa-archive"></i> Old Reports
                </a>
                <div class="dropdown">
                    <a class="list-group-item list-group-item-action bg-primary text-white dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-cog"></i> Management
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="users.html"><i class="fas fa-users"></i> Users</a></li>
                        <li><a class="dropdown-item" href="companies.html"><i class="fas fa-building"></i> Companies</a></li>
                        <li><a class="dropdown-item" href="racks.html"><i class="fas fa-layer-group"></i> Racks</a></li>
                    </ul>
                </div>
                <a href="../index.html" class="list-group-item list-group-item-action bg-danger text-white" id="sidebarLogoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
                <div class="container-fluid">
                    <button class="btn btn-primary" id="menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="navbar-nav ms-auto">
                        <div class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <img id="navbarAvatar" class="navbar-user-avatar" src="https://ui-avatars.com/api/?name=User&background=667eea&color=fff&size=32" alt="Avatar">
                                <span id="userDisplayName">Loading...</span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#"><i class="fas fa-user"></i> Profile</a></li>
                                <li><a class="dropdown-item active" href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="container-fluid px-4 mt-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2><i class="fas fa-cog"></i> Settings</h2>
                        <p class="text-muted mb-0">Manage your account and application preferences</p>
                    </div>
                    <a href="dashboard.html" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back
                    </a>
                </div>

                <div id="alertContainer"></div>

                <!-- Settings Tabs -->
                <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#profile">
                            <i class="fas fa-user"></i> Profile
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#account">
                            <i class="fas fa-id-card"></i> Account
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#security">
                            <i class="fas fa-shield-alt"></i> Security
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#notifications">
                            <i class="fas fa-bell"></i> Notifications
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#preferences">
                            <i class="fas fa-sliders-h"></i> Preferences
                        </a>
                    </li>
                </ul>

                <div class="tab-content mt-3">
                    <!-- Profile Tab -->
                    <div class="tab-pane fade show active" id="profile">
                        <div class="settings-card">
                            <h3><i class="fas fa-user-circle"></i> Profile Information</h3>
                            <p>Update your personal details and profile picture</p>

                            <div class="avatar-section">
                                <div class="avatar-preview">
                                    <img id="avatarImage" src="https://ui-avatars.com/api/?name=User&background=667eea&color=fff&size=100" alt="Profile">
                                </div>
                                <div>
                                    <button class="btn btn-primary" onclick="document.getElementById('avatarInput').click()">
                                        <i class="fas fa-upload"></i> Upload Photo
                                    </button>
                                    <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                                    <p class="text-muted mt-2 mb-0" style="font-size: 13px;">JPG, PNG or GIF. Max 2MB</p>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="fullName" placeholder="Enter full name">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Username</label>
                                    <input type="text" class="form-control" id="username" placeholder="Enter username">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" placeholder="Enter email">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="phone" placeholder="Enter phone">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Bio</label>
                                <textarea class="form-control" id="bio" rows="3" placeholder="Tell us about yourself"></textarea>
                            </div>

                            <button class="btn btn-primary" onclick="saveProfile()">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                            <button class="btn btn-secondary ms-2" onclick="loadUserData()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Account Tab -->
                    <div class="tab-pane fade" id="account">
                        <div class="settings-card">
                            <h3><i class="fas fa-id-badge"></i> Account Information</h3>
                            <p>View and manage your account details</p>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="info-box">
                                        <strong>User ID</strong>
                                        <span id="userId">Loading...</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-box">
                                        <strong>Role</strong>
                                        <span id="accountRole">Loading...</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-box">
                                        <strong>Email</strong>
                                        <span id="accountEmail">Loading...</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-box">
                                        <strong>Member Since</strong>
                                        <span id="accountCreated">Loading...</span>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Company</label>
                                <select class="form-control" id="company">
                                    <option value="">Select Company</option>
                                    <option value="1">ABC Corporation</option>
                                    <option value="2">XYZ Industries</option>
                                    <option value="3">Tech Solutions</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Department</label>
                                <input type="text" class="form-control" id="department" placeholder="Enter department">
                            </div>

                            <button class="btn btn-primary" onclick="saveAccount()">
                                <i class="fas fa-save"></i> Update
                            </button>
                        </div>

                        <div class="settings-card">
                            <div class="danger-zone">
                                <h4><i class="fas fa-exclamation-triangle"></i> Danger Zone</h4>
                                <p class="mb-3">Delete your account permanently. This action cannot be undone.</p>
                                <button class="btn-danger-action" onclick="deleteAccount()">
                                    <i class="fas fa-trash"></i> Delete Account
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Security Tab -->
                    <div class="tab-pane fade" id="security">
                        <div class="settings-card">
                            <h3><i class="fas fa-key"></i> Change Password</h3>
                            <p>Keep your account secure with a strong password</p>

                            <div class="mb-3">
                                <label class="form-label">Current Password</label>
                                <input type="password" class="form-control" id="currentPassword" placeholder="Enter current password">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">New Password</label>
                                <input type="password" class="form-control" id="newPassword" placeholder="Enter new password">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Confirm Password</label>
                                <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm new password">
                            </div>

                            <button class="btn btn-primary" onclick="changePassword()">
                                <i class="fas fa-key"></i> Update Password
                            </button>
                        </div>

                        <div class="settings-card">
                            <h3><i class="fas fa-shield-alt"></i> Two-Factor Authentication</h3>
                            <p>Add extra security to your account</p>

                            <div class="setting-row">
                                <div class="setting-info">
                                    <h5>Enable 2FA</h5>
                                    <p>Require verification code when logging in</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enable2FA">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="settings-card">
                            <h3><i class="fas fa-laptop"></i> Active Sessions</h3>
                            <p>Manage devices where you're logged in</p>

                            <div class="setting-row">
                                <div class="setting-info">
                                    <h5>Current Device</h5>
                                    <p>Active now</p>
                                </div>
                                <button class="btn btn-outline-danger btn-sm" onclick="handleLogout()">Logout</button>
                            </div>

                            <button class="btn btn-outline-danger mt-3" onclick="handleLogout()">
                                <i class="fas fa-sign-out-alt"></i> Logout All Devices
                            </button>
                        </div>
                    </div>

                    <!-- Notifications Tab -->
                    <div class="tab-pane fade" id="notifications">
                        <div class="settings-card">
                            <h3><i class="fas fa-envelope"></i> Email Notifications</h3>
                            <p>Control what emails you receive</p>

                            <div class="setting-row">
                                <div class="setting-info">
                                    <h5>File Updates</h5>
                                    <p>Notifications when files are updated</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="emailFileUpdates" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="setting-row">
                                <div class="setting-info">
                                    <h5>Overdue Alerts</h5>
                                    <p>Get notified about overdue files</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="emailOverdue" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="setting-row">
                                <div class="setting-info">
                                    <h5>Weekly Reports</h5>
                                    <p>Weekly summary of activities</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="emailWeekly">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="settings-card">
                            <h3><i class="fas fa-desktop"></i> System Notifications</h3>
                            <p>In-app notification preferences</p>

                            <div class="setting-row">
                                <div class="setting-info">
                                    <h5>Desktop Notifications</h5>
                                    <p>Show desktop alerts</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="desktopNotif" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="setting-row">
                                <div class="setting-info">
                                    <h5>Sound Alerts</h5>
                                    <p>Play sound for notifications</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="soundAlerts">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="saveNotifications()">
                            <i class="fas fa-save"></i> Save Preferences
                        </button>
                    </div>

                    <!-- Preferences Tab -->
                    <div class="tab-pane fade" id="preferences">
                        <div class="settings-card">
                            <h3><i class="fas fa-palette"></i> Appearance</h3>
                            <p>Customize the look and feel</p>

                            <div class="mb-3">
                                <label class="form-label">Theme</label>
                                <select class="form-control" id="theme" onchange="applyTheme(this.value)">
                                    <option value="light">Light</option>
                                    <option value="dark">Dark</option>
                                    <option value="auto">System Default</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Language</label>
                                <select class="form-control" id="language" onchange="applyLanguage(this.value)">
                                    <option value="en">English</option>
                                    <option value="es">Spanish</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Timezone</label>
                                <select class="form-control" id="timezone" onchange="applyTimezone(this.value)">
                                    <option value="UTC">UTC (+00:00)</option>
                                    <option value="America/New_York">Eastern Time (ET)</option>
                                    <option value="America/Los_Angeles">Pacific Time (PT)</option>
                                    <option value="America/Chicago">Central Time (CT)</option>
                                    <option value="Asia/Kolkata">India Standard Time (IST)</option>
                                    <option value="Europe/London">London (GMT)</option>
                                    <option value="Asia/Tokyo">Tokyo (JST)</option>
                                    <option value="Australia/Sydney">Sydney (AEDT)</option>
                                </select>
                            </div>
                        </div>

                        <div class="settings-card">
                            <h3><i class="fas fa-cogs"></i> Application</h3>
                            <p>Configure app behavior</p>

                            <div class="mb-3">
                                <label class="form-label">Default View</label>
                                <select class="form-control" id="defaultView" onchange="savePreferenceInstant('defaultView', this.value)">
                                    <option value="grid">Grid View</option>
                                    <option value="list">List View</option>
                                    <option value="table">Table View</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Items Per Page</label>
                                <select class="form-control" id="itemsPerPage" onchange="savePreferenceInstant('itemsPerPage', this.value)">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>

                            <div class="setting-row">
                                <div class="setting-info">
                                    <h5>Auto-Save Forms</h5>
                                    <p>Save drafts automatically</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="autoSave" checked onchange="savePreferenceInstant('autoSave', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="setting-row">
                                <div class="setting-info">
                                    <h5>Compact Mode</h5>
                                    <p>Show more content in less space</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="compactMode" onchange="applyCompactMode(this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="savePreferences()">
                            <i class="fas fa-save"></i> Save Preferences
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { auth, db } from '../assets/js/firebase.js';
        import { onAuthStateChanged, signOut, updatePassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        let currentUser = null;

        onAuthStateChanged(auth, async (firebaseUser) => {
            if (!firebaseUser) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = firebaseUser;
            await loadUserData();
        });

        async function loadUserData() {
            try {
                const userData = localStorage.getItem('user');
                if (userData) {
                    const user = JSON.parse(userData);
                    
                    document.getElementById('fullName').value = user.username || '';
                    document.getElementById('username').value = user.username || '';
                    document.getElementById('email').value = user.email || currentUser.email;
                    
                    document.getElementById('userId').textContent = user.uid || currentUser.uid;
                    document.getElementById('accountRole').textContent = (user.role || 'user').toUpperCase();
                    document.getElementById('accountEmail').textContent = user.email || currentUser.email;
                    document.getElementById('accountCreated').textContent = new Date(currentUser.metadata.creationTime).toLocaleDateString();
                    
                    const displayName = user.username || user.email.split('@')[0];
                    const role = (user.role || 'User').charAt(0).toUpperCase() + (user.role || 'User').slice(1);
                    document.getElementById('userDisplayName').textContent = displayName + ' (' + role + ')';
                    
                    // Load avatar from localStorage or use default
                    const savedAvatar = localStorage.getItem('userAvatar');
                    const avatarUrl = savedAvatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username || user.email)}&background=667eea&color=fff&size=100`;
                    document.getElementById('avatarImage').src = avatarUrl;
                    document.getElementById('navbarAvatar').src = avatarUrl;
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        window.loadUserData = loadUserData;

        window.saveProfile = async function() {
            try {
                const fullName = document.getElementById('fullName').value;
                const phone = document.getElementById('phone').value;
                const bio = document.getElementById('bio').value;

                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, { username: fullName, phone, bio });

                const userData = JSON.parse(localStorage.getItem('user'));
                userData.username = fullName;
                userData.phone = phone;
                userData.bio = bio;
                localStorage.setItem('user', JSON.stringify(userData));

                showAlert('Profile updated successfully!', 'success');
                await loadUserData();
            } catch (error) {
                showAlert('Failed to update profile.', 'error');
            }
        };

        window.saveAccount = async function() {
            try {
                const department = document.getElementById('department').value;
                const company = document.getElementById('company').value;

                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, { department, company_id: company });

                showAlert('Account updated!', 'success');
            } catch (error) {
                showAlert('Failed to update account.', 'error');
            }
        };

        window.changePassword = async function() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!newPassword || newPassword !== confirmPassword) {
                showAlert('Passwords do not match', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showAlert('Password must be at least 6 characters', 'error');
                return;
            }

            try {
                await updatePassword(currentUser, newPassword);
                showAlert('Password changed successfully!', 'success');
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            } catch (error) {
                if (error.code === 'auth/requires-recent-login') {
                    showAlert('Please log out and log back in to change password', 'error');
                } else {
                    showAlert('Failed to change password', 'error');
                }
            }
        };

        window.saveNotifications = function() {
            const settings = {
                emailFileUpdates: document.getElementById('emailFileUpdates').checked,
                emailOverdue: document.getElementById('emailOverdue').checked,
                emailWeekly: document.getElementById('emailWeekly').checked,
                desktopNotif: document.getElementById('desktopNotif').checked,
                soundAlerts: document.getElementById('soundAlerts').checked
            };
            localStorage.setItem('notificationSettings', JSON.stringify(settings));
            showAlert('Notifications saved!', 'success');
        };

        window.applyTheme = function(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
            } else if (theme === 'light') {
                document.body.classList.remove('dark-theme');
            } else {
                // Auto - detect system preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark-theme');
                } else {
                    document.body.classList.remove('dark-theme');
                }
            }
            savePreferenceInstant('theme', theme);
        };

        window.applyLanguage = function(lang) {
            const langNames = {
                'en': 'English',
                'es': 'Español',
                'fr': 'Français',
                'de': 'Deutsch'
            };
            savePreferenceInstant('language', lang);
            showAlert(`Language set to ${langNames[lang]}`, 'success');
        };

        window.applyTimezone = function(tz) {
            savePreferenceInstant('timezone', tz);
            showAlert('Timezone updated', 'success');
        };

        window.applyCompactMode = function(enabled) {
            if (enabled) {
                document.body.classList.add('compact-mode');
            } else {
                document.body.classList.remove('compact-mode');
            }
            savePreferenceInstant('compactMode', enabled);
        };

        window.savePreferenceInstant = function(key, value) {
            const prefs = JSON.parse(localStorage.getItem('userPreferences') || '{}');
            prefs[key] = value;
            localStorage.setItem('userPreferences', JSON.stringify(prefs));
        };

        window.savePreferences = function() {
            const prefs = {
                theme: document.getElementById('theme').value,
                language: document.getElementById('language').value,
                timezone: document.getElementById('timezone').value,
                defaultView: document.getElementById('defaultView').value,
                itemsPerPage: document.getElementById('itemsPerPage').value,
                autoSave: document.getElementById('autoSave').checked,
                compactMode: document.getElementById('compactMode').checked
            };
            localStorage.setItem('userPreferences', JSON.stringify(prefs));
            applyTheme(prefs.theme);
            applyCompactMode(prefs.compactMode);
            showAlert('All preferences saved!', 'success');
        };

        window.deleteAccount = function() {
            if (confirm('Delete account? This cannot be undone.')) {
                showAlert('Contact admin to delete account', 'error');
            }
        };

        window.handleLogout = async function() {
            if (confirm('Logout?')) {
                try {
                    await signOut(auth);
                    localStorage.clear();
                    window.location.href = 'login.html';
                } catch (error) {
                    alert('Logout failed');
                }
            }
        };

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `
                <div class="alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            setTimeout(() => alertContainer.innerHTML = '', 5000);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        document.getElementById('avatarInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 2 * 1024 * 1024) {
                    showAlert('Image too large (max 2MB)', 'error');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const avatarDataUrl = e.target.result;
                    // Update both avatar images
                    document.getElementById('avatarImage').src = avatarDataUrl;
                    document.getElementById('navbarAvatar').src = avatarDataUrl;
                    // Save to localStorage
                    localStorage.setItem('userAvatar', avatarDataUrl);
                    showAlert('Avatar updated successfully!', 'success');
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('menu-toggle').addEventListener('click', () => {
            document.getElementById('wrapper').classList.toggle('toggled');
        });

        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        document.getElementById('sidebarLogoutBtn').addEventListener('click', handleLogout);

        window.addEventListener('load', function() {
            const savedPrefs = localStorage.getItem('userPreferences');
            if (savedPrefs) {
                const prefs = JSON.parse(savedPrefs);
                if (prefs.theme) {
                    document.getElementById('theme').value = prefs.theme;
                    applyTheme(prefs.theme);
                }
                if (prefs.language) document.getElementById('language').value = prefs.language;
                if (prefs.timezone) document.getElementById('timezone').value = prefs.timezone;
                if (prefs.defaultView) document.getElementById('defaultView').value = prefs.defaultView;
                if (prefs.itemsPerPage) document.getElementById('itemsPerPage').value = prefs.itemsPerPage;
                if (prefs.autoSave !== undefined) document.getElementById('autoSave').checked = prefs.autoSave;
                if (prefs.compactMode !== undefined) {
                    document.getElementById('compactMode').checked = prefs.compactMode;
                    applyCompactMode(prefs.compactMode);
                }
            }

            const savedNotif = localStorage.getItem('notificationSettings');
            if (savedNotif) {
                const notif = JSON.parse(savedNotif);
                Object.keys(notif).forEach(key => {
                    const elem = document.getElementById(key);
                    if (elem && notif[key] !== undefined) elem.checked = notif[key];
                });
            }
        });
    </script>
</body>
</html>
