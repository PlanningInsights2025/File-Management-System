<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Old Reports Archive - FMS</title>
    <!-- Version 2.0 - Fixed JavaScript rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        .report-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        .report-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #3498db;
        }
        .report-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        .report-meta {
            font-size: 0.85rem;
            color: #7f8c8d;
        }
        .report-size {
            font-size: 0.8rem;
            color: #95a5a6;
        }
        .filter-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #dee2e6;
        }
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        .stat-box.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        .stat-box.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .stat-box.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        .timeline-item {
            border-left: 3px solid #3498db;
            padding-left: 20px;
            margin-bottom: 20px;
            position: relative;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 0;
            width: 13px;
            height: 13px;
            border-radius: 50%;
            background: #3498db;
            border: 3px solid white;
        }
        .action-buttons .btn {
            margin: 5px;
            min-width: 100px;
        }
        .report-preview {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        .badge-report-type {
            padding: 5px 10px;
            font-size: 0.75rem;
            border-radius: 15px;
        }
        .search-highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="fas fa-folder"></i> FMS
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a class="nav-link" href="create-file.html"><i class="fas fa-plus-circle"></i> Create File</a>
                <a class="nav-link" href="file-list.html"><i class="fas fa-list"></i> File List</a>
                <a class="nav-link" href="reports.html"><i class="fas fa-chart-bar"></i> Reports</a>
                <a class="nav-link active" href="old-reports.html"><i class="fas fa-archive"></i> Old Reports</a>
                <a class="nav-link" href="../index.html"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-md-12">
                <h2><i class="fas fa-archive"></i> Old Reports Archive</h2>
                <p class="text-muted">View, download, and manage previously generated reports</p>
            </div>
        </div>

        <!-- Statistics Row -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="stat-box">
                    <div class="stat-number" id="totalReports">0</div>
                    <div class="stat-label">
                        <i class="fas fa-file-alt"></i> Total Reports
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-box success">
                    <div class="stat-number" id="thisMonthReports">0</div>
                    <div class="stat-label">
                        <i class="fas fa-calendar-check"></i> This Month
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-box warning">
                    <div class="stat-number" id="archivedSize">0 MB</div>
                    <div class="stat-label">
                        <i class="fas fa-database"></i> Total Size
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-box info">
                    <div class="stat-number" id="reportTypes">0</div>
                    <div class="stat-label">
                        <i class="fas fa-tags"></i> Report Types
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Filters Section -->
            <div class="col-lg-3">
                <div class="filter-section">
                    <h5 class="mb-3"><i class="fas fa-filter"></i> Filter Reports</h5>
                    
                    <!-- Search -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-search"></i> Search
                        </label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search reports...">
                    </div>

                    <!-- Report Type -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-file-alt"></i> Report Type
                        </label>
                        <select class="form-select" id="filterReportType">
                            <option value="">All Types</option>
                            <option value="movement">File Movement</option>
                            <option value="usage">File Usage</option>
                            <option value="compliance">Compliance</option>
                            <option value="overdue">Overdue Files</option>
                            <option value="department">Department</option>
                            <option value="user">User Activity</option>
                            <option value="audit">Audit Trail</option>
                            <option value="summary">Monthly Summary</option>
                        </select>
                    </div>

                    <!-- Date Range -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-calendar-alt"></i> Date Range
                        </label>
                        <select class="form-select mb-2" id="dateRangePreset">
                            <option value="">Custom Range</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                        </select>
                        <input type="date" class="form-control mb-2" id="filterDateFrom" placeholder="From">
                        <input type="date" class="form-control" id="filterDateTo" placeholder="To">
                    </div>

                    <!-- Generated By -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-user"></i> Generated By
                        </label>
                        <select class="form-select" id="filterUser">
                            <option value="">All Users</option>
                            <option value="admin">Admin User</option>
                            <option value="john">John Smith</option>
                            <option value="sarah">Sarah Johnson</option>
                            <option value="mike">Mike Wilson</option>
                        </select>
                    </div>

                    <!-- Format -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-file-export"></i> Format
                        </label>
                        <select class="form-select" id="filterFormat">
                            <option value="">All Formats</option>
                            <option value="pdf">PDF</option>
                            <option value="excel">Excel</option>
                            <option value="csv">CSV</option>
                            <option value="html">HTML</option>
                        </select>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" id="applyFilters">
                            <i class="fas fa-check"></i> Apply Filters
                        </button>
                        <button class="btn btn-secondary" id="resetFilters">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>

                    <!-- Quick Stats -->
                    <div class="mt-4 pt-3 border-top">
                        <h6 class="mb-3"><i class="fas fa-chart-pie"></i> Quick Stats</h6>
                        <div class="small">
                            <div class="d-flex justify-content-between mb-2">
                                <span>PDF Reports:</span>
                                <strong id="pdfCount">0</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Excel Reports:</span>
                                <strong id="excelCount">0</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>CSV Reports:</span>
                                <strong id="csvCount">0</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Largest Report:</span>
                                <strong id="largestReport">0 MB</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports List Section -->
            <div class="col-lg-9">
                <!-- View Toggle -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <button class="btn btn-sm btn-outline-primary" id="viewCards" title="Card View">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary active" id="viewTable" title="Table View">
                            <i class="fas fa-table"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary" id="viewTimeline" title="Timeline View">
                            <i class="fas fa-stream"></i>
                        </button>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-success" id="bulkDownload">
                            <i class="fas fa-download"></i> Bulk Download
                        </button>
                        <button class="btn btn-sm btn-warning" id="bulkArchive">
                            <i class="fas fa-archive"></i> Archive Selected
                        </button>
                        <button class="btn btn-sm btn-danger" id="bulkDelete">
                            <i class="fas fa-trash"></i> Delete Selected
                        </button>
                    </div>
                </div>

                <!-- Table View -->
                <div id="tableView" class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-list"></i> Archived Reports
                            <span class="badge bg-light text-dark ms-2" id="reportCount">0 reports</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="reportsTable">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAll"></th>
                                        <th>Report Name</th>
                                        <th>Type</th>
                                        <th>Generated</th>
                                        <th>Generated By</th>
                                        <th>Period</th>
                                        <th>Format</th>
                                        <th>Size</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="reportsTableBody">
                                    <!-- Reports will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Card View -->
                <div id="cardView" class="d-none">
                    <div class="row" id="reportsCardContainer">
                        <!-- Report cards will be loaded here -->
                    </div>
                </div>

                <!-- Timeline View -->
                <div id="timelineView" class="d-none">
                    <div class="card shadow">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-stream"></i> Reports Timeline</h5>
                        </div>
                        <div class="card-body">
                            <div id="timelineContainer">
                                <!-- Timeline items will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-eye"></i> Report Preview
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="reportPreviewContent">
                        <!-- Preview content will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="downloadFromPreview">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle"></i> Report Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="reportDetailsContent">
                        <!-- Details will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="../assets/js/app.js"></script>

    <script>
        // Sample archived reports data
        const archivedReports = [
            {
                id: 1,
                name: 'File Movement Report - January 2024',
                type: 'movement',
                generated: '2024-01-31 23:45',
                generatedBy: 'Admin User',
                period: 'Jan 1-31, 2024',
                format: 'pdf',
                size: '2.4 MB',
                records: 1250,
                status: 'completed'
            },
            {
                id: 2,
                name: 'Compliance Audit Report - Q4 2023',
                type: 'compliance',
                generated: '2023-12-31 18:30',
                generatedBy: 'Sarah Johnson',
                period: 'Oct-Dec 2023',
                format: 'excel',
                size: '5.8 MB',
                records: 3420,
                status: 'completed'
            },
            {
                id: 3,
                name: 'Department Activity - December 2023',
                type: 'department',
                generated: '2023-12-31 16:20',
                generatedBy: 'John Smith',
                period: 'Dec 1-31, 2023',
                format: 'pdf',
                size: '1.9 MB',
                records: 890,
                status: 'completed'
            },
            {
                id: 4,
                name: 'Overdue Files Report - November 2023',
                type: 'overdue',
                generated: '2023-11-30 22:15',
                generatedBy: 'Admin User',
                period: 'Nov 1-30, 2023',
                format: 'csv',
                size: '0.8 MB',
                records: 145,
                status: 'completed'
            },
            {
                id: 5,
                name: 'User Activity Summary - Q3 2023',
                type: 'user',
                generated: '2023-09-30 20:00',
                generatedBy: 'Mike Wilson',
                period: 'Jul-Sep 2023',
                format: 'excel',
                size: '4.2 MB',
                records: 2180,
                status: 'completed'
            },
            {
                id: 6,
                name: 'Annual Audit Trail - 2023',
                type: 'audit',
                generated: '2023-12-31 23:59',
                generatedBy: 'Admin User',
                period: 'Full Year 2023',
                format: 'pdf',
                size: '12.5 MB',
                records: 8950,
                status: 'completed'
            },
            {
                id: 7,
                name: 'File Usage Report - October 2023',
                type: 'usage',
                generated: '2023-10-31 19:45',
                generatedBy: 'Sarah Johnson',
                period: 'Oct 1-31, 2023',
                format: 'excel',
                size: '3.1 MB',
                records: 1560,
                status: 'completed'
            },
            {
                id: 8,
                name: 'Monthly Summary - September 2023',
                type: 'summary',
                generated: '2023-09-30 23:30',
                generatedBy: 'Admin User',
                period: 'Sep 1-30, 2023',
                format: 'pdf',
                size: '1.5 MB',
                records: 720,
                status: 'completed'
            }
        ];

        let selectedReports = [];
        let dataTable;

        $(document).ready(function() {
            console.log('Old Reports page loaded');
            
            // Initialize the page
            initializePage();
            loadReports();
            setupEventHandlers();
            updateStatistics();
        });

        function initializePage() {
            // Set default dates
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            $('#filterDateFrom').val(firstDay.toISOString().split('T')[0]);
            $('#filterDateTo').val(today.toISOString().split('T')[0]);
        }

        function setupEventHandlers() {
            // View toggles
            $('#viewTable').click(() => switchView('table'));
            $('#viewCards').click(() => switchView('cards'));
            $('#viewTimeline').click(() => switchView('timeline'));

            // Filter controls
            $('#applyFilters').click(applyFilters);
            $('#resetFilters').click(resetFilters);
            $('#searchInput').on('keyup', performSearch);
            $('#dateRangePreset').change(handleDatePresetChange);

            // Select all checkbox
            $('#selectAll').change(function() {
                $('.report-checkbox').prop('checked', $(this).prop('checked'));
                updateSelectedReports();
            });

            // Bulk actions
            $('#bulkDownload').click(bulkDownloadReports);
            $('#bulkArchive').click(bulkArchiveReports);
            $('#bulkDelete').click(bulkDeleteReports);
        }

        function loadReports() {
            const tbody = $('#reportsTableBody');
            tbody.empty();

            archivedReports.forEach(report => {
                const row = '<tr>' +
                    '<td><input type="checkbox" class="report-checkbox" data-id="' + report.id + '"></td>' +
                    '<td><strong>' + report.name + '</strong><br><small class="text-muted">' + report.records + ' records</small></td>' +
                    '<td><span class="badge badge-report-type ' + getReportTypeBadgeClass(report.type) + '">' + formatReportType(report.type) + '</span></td>' +
                    '<td>' + report.generated + '</td>' +
                    '<td><i class="fas fa-user-circle"></i> ' + report.generatedBy + '</td>' +
                    '<td>' + report.period + '</td>' +
                    '<td><i class="' + getFormatIcon(report.format) + '"></i> ' + report.format.toUpperCase() + '</td>' +
                    '<td>' + report.size + '</td>' +
                    '<td>' +
                        '<div class="btn-group btn-group-sm">' +
                            '<button class="btn btn-outline-primary" onclick="previewReport(' + report.id + ')" title="Preview"><i class="fas fa-eye"></i></button>' +
                            '<button class="btn btn-outline-success" onclick="downloadReport(' + report.id + ')" title="Download"><i class="fas fa-download"></i></button>' +
                            '<button class="btn btn-outline-info" onclick="viewDetails(' + report.id + ')" title="Details"><i class="fas fa-info-circle"></i></button>' +
                            '<button class="btn btn-outline-danger" onclick="deleteReport(' + report.id + ')" title="Delete"><i class="fas fa-trash"></i></button>' +
                        '</div>' +
                    '</td>' +
                '</tr>';
                tbody.append(row);
            });

            // Initialize DataTable
            if (dataTable) {
                dataTable.destroy();
            }
            
            dataTable = $('#reportsTable').DataTable({
                order: [[3, 'desc']],
                pageLength: 10,
                language: {
                    search: 'Search reports:',
                    lengthMenu: 'Show _MENU_ reports per page',
                    info: 'Showing _START_ to _END_ of _TOTAL_ reports'
                }
            });

            // Attach checkbox event handlers
            $('.report-checkbox').change(updateSelectedReports);

            // Load card view
            loadCardView();
            
            // Load timeline view
            loadTimelineView();
        }

        function loadCardView() {
            const container = $('#reportsCardContainer');
            container.empty();

            archivedReports.forEach(report => {
                const card = '<div class="col-md-4">' +
                    '<div class="report-card">' +
                        '<div class="text-center">' +
                            '<div class="report-icon">' +
                                '<i class="' + getReportTypeIcon(report.type) + '"></i>' +
                            '</div>' +
                            '<div class="report-title">' + report.name + '</div>' +
                            '<span class="badge badge-report-type ' + getReportTypeBadgeClass(report.type) + ' mb-2">' + formatReportType(report.type) + '</span>' +
                            '<div class="report-meta">' +
                                '<i class="fas fa-calendar"></i> ' + report.generated + '<br>' +
                                '<i class="fas fa-user"></i> ' + report.generatedBy + '<br>' +
                                '<i class="fas fa-clock"></i> ' + report.period +
                            '</div>' +
                            '<div class="report-size mt-2">' +
                                '<i class="fas fa-database"></i> ' + report.size + ' | ' +
                                '<i class="fas fa-file-alt"></i> ' + report.records + ' records' +
                            '</div>' +
                            '<div class="mt-3">' +
                                '<button class="btn btn-sm btn-primary" onclick="previewReport(' + report.id + ')"><i class="fas fa-eye"></i> Preview</button>' +
                                '<button class="btn btn-sm btn-success" onclick="downloadReport(' + report.id + ')"><i class="fas fa-download"></i> Download</button>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
                container.append(card);
            });
        }

        function loadTimelineView() {
            const container = $('#timelineContainer');
            container.empty();

            archivedReports.forEach(report => {
                const timeline = '<div class="timeline-item">' +
                    '<div class="d-flex justify-content-between align-items-start">' +
                        '<div>' +
                            '<h6 class="mb-1">' + report.name + '</h6>' +
                            '<span class="badge badge-report-type ' + getReportTypeBadgeClass(report.type) + '">' + formatReportType(report.type) + '</span>' +
                            '<div class="text-muted small mt-2">' +
                                '<i class="fas fa-calendar"></i> ' + report.generated + ' | ' +
                                '<i class="fas fa-user"></i> ' + report.generatedBy + ' | ' +
                                '<i class="fas fa-database"></i> ' + report.size +
                            '</div>' +
                            '<div class="report-preview">' +
                                '<strong>Period:</strong> ' + report.period + '<br>' +
                                '<strong>Records:</strong> ' + report.records + ' | ' +
                                '<strong>Format:</strong> ' + report.format.toUpperCase() +
                            '</div>' +
                        '</div>' +
                        '<div>' +
                            '<button class="btn btn-sm btn-outline-primary" onclick="previewReport(' + report.id + ')"><i class="fas fa-eye"></i></button>' +
                            '<button class="btn btn-sm btn-outline-success" onclick="downloadReport(' + report.id + ')"><i class="fas fa-download"></i></button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
                container.append(timeline);
            });
        }

        function switchView(view) {
            // Update button states
            $('.btn-outline-primary').removeClass('active');
            
            // Hide all views
            $('#tableView').addClass('d-none');
            $('#cardView').addClass('d-none');
            $('#timelineView').addClass('d-none');
            
            // Show selected view
            if (view === 'table') {
                $('#tableView').removeClass('d-none');
                $('#viewTable').addClass('active');
            } else if (view === 'cards') {
                $('#cardView').removeClass('d-none');
                $('#viewCards').addClass('active');
            } else if (view === 'timeline') {
                $('#timelineView').removeClass('d-none');
                $('#viewTimeline').addClass('active');
            }
        }

        function updateStatistics() {
            // Calculate statistics
            const totalReports = archivedReports.length;
            const thisMonth = archivedReports.filter(r => r.generated.startsWith('2024-01')).length;
            const totalSize = archivedReports.reduce((sum, r) => sum + parseFloat(r.size), 0).toFixed(1);
            const reportTypes = new Set(archivedReports.map(r => r.type)).size;
            
            const pdfCount = archivedReports.filter(r => r.format === 'pdf').length;
            const excelCount = archivedReports.filter(r => r.format === 'excel').length;
            const csvCount = archivedReports.filter(r => r.format === 'csv').length;
            const largest = Math.max(...archivedReports.map(r => parseFloat(r.size))).toFixed(1);

            // Update UI
            $('#totalReports').text(totalReports);
            $('#thisMonthReports').text(thisMonth);
            $('#archivedSize').text(totalSize + ' MB');
            $('#reportTypes').text(reportTypes);
            $('#reportCount').text(totalReports + ' reports');
            
            $('#pdfCount').text(pdfCount);
            $('#excelCount').text(excelCount);
            $('#csvCount').text(csvCount);
            $('#largestReport').text(largest + ' MB');
        }

        function updateSelectedReports() {
            selectedReports = [];
            $('.report-checkbox:checked').each(function() {
                selectedReports.push($(this).data('id'));
            });
            console.log('Selected reports:', selectedReports);
        }

        function applyFilters() {
            // Get filter values
            const type = $('#filterReportType').val();
            const user = $('#filterUser').val();
            const format = $('#filterFormat').val();
            const dateFrom = $('#filterDateFrom').val();
            const dateTo = $('#filterDateTo').val();

            showAlert('Filters applied! Found matching reports.', 'success');
            
            // In a real app, this would filter the reports
            // For now, just reload the reports
            loadReports();
        }

        function resetFilters() {
            $('#filterReportType').val('');
            $('#filterUser').val('');
            $('#filterFormat').val('');
            $('#dateRangePreset').val('');
            $('#searchInput').val('');
            
            initializePage();
            loadReports();
            
            showAlert('Filters reset', 'info');
        }

        function performSearch() {
            const searchTerm = $(this).val().toLowerCase();
            if (dataTable) {
                dataTable.search(searchTerm).draw();
            }
        }

        function handleDatePresetChange() {
            const preset = $(this).val();
            const today = new Date();
            let fromDate, toDate;

            switch(preset) {
                case 'today':
                    fromDate = toDate = today;
                    break;
                case 'week':
                    fromDate = new Date(today.setDate(today.getDate() - 7));
                    toDate = new Date();
                    break;
                case 'month':
                    fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    toDate = new Date();
                    break;
                case 'quarter':
                    const quarter = Math.floor(today.getMonth() / 3);
                    fromDate = new Date(today.getFullYear(), quarter * 3, 1);
                    toDate = new Date();
                    break;
                case 'year':
                    fromDate = new Date(today.getFullYear(), 0, 1);
                    toDate = new Date();
                    break;
                default:
                    return;
            }

            $('#filterDateFrom').val(fromDate.toISOString().split('T')[0]);
            $('#filterDateTo').val(toDate.toISOString().split('T')[0]);
        }

        function previewReport(id) {
            const report = archivedReports.find(r => r.id === id);
            if (!report) return;

            // Store current report ID for download button
            currentPreviewReportId = id;

            const content = '<div class="text-center mb-3">' +
                '<h4>' + report.name + '</h4>' +
                '<span class="badge badge-report-type ' + getReportTypeBadgeClass(report.type) + ' mb-2">' + formatReportType(report.type) + '</span>' +
                '<p class="text-muted">Period: ' + report.period + '</p>' +
                '</div>' +
                '<div class="alert alert-info">' +
                '<h6>Report Summary</h6>' +
                '<ul>' +
                    '<li><strong>Generated:</strong> ' + report.generated + '</li>' +
                    '<li><strong>Generated By:</strong> ' + report.generatedBy + '</li>' +
                    '<li><strong>Total Records:</strong> ' + report.records + '</li>' +
                    '<li><strong>Format:</strong> ' + report.format.toUpperCase() + '</li>' +
                    '<li><strong>File Size:</strong> ' + report.size + '</li>' +
                '</ul>' +
                '</div>' +
                '<div class="border rounded p-3 bg-light">' +
                '<p><em>Report preview would be displayed here...</em></p>' +
                '<p>This is a sample preview of the ' + report.name + ' report.</p>' +
                '</div>';

            $('#reportPreviewContent').html(content);
            $('#previewModal').modal('show');
        }

        function downloadReport(id) {
            const report = archivedReports.find(r => r.id === id);
            if (!report) return;

            showAlert('Downloading ' + report.name + '...', 'info');
            
            // Create a sample PDF content
            const content = `
File Management System - Report

${report.name}

Generated: ${report.generated}
Generated By: ${report.generatedBy}
Period: ${report.period}
Total Records: ${report.records}

This is a sample ${report.type} report generated by the File Management System.

Report Summary:
- Total Files Processed: ${report.records}
- Report Period: ${report.period}
- Generated On: ${report.generated}

For full details, please refer to the complete report.
            `;
            
            // Create blob and download
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = report.name.replace(/\s+/g, '_') + '.txt';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            setTimeout(() => {
                showAlert('Download complete!', 'success');
            }, 500);
        }

        // Handle download from preview modal
        let currentPreviewReportId = null;
        
        document.getElementById('downloadFromPreview').addEventListener('click', function() {
            if (currentPreviewReportId) {
                downloadReport(currentPreviewReportId);
            }
        });

        function viewDetails(id) {
            const report = archivedReports.find(r => r.id === id);
            if (!report) return;

            const content = '<table class="table table-bordered">' +
                '<tr><th width="200">Report Name</th><td>' + report.name + '</td></tr>' +
                '<tr><th>Type</th><td>' + formatReportType(report.type) + '</td></tr>' +
                '<tr><th>Generated</th><td>' + report.generated + '</td></tr>' +
                '<tr><th>Generated By</th><td>' + report.generatedBy + '</td></tr>' +
                '<tr><th>Period</th><td>' + report.period + '</td></tr>' +
                '<tr><th>Format</th><td>' + report.format.toUpperCase() + '</td></tr>' +
                '<tr><th>File Size</th><td>' + report.size + '</td></tr>' +
                '<tr><th>Total Records</th><td>' + report.records + '</td></tr>' +
                '<tr><th>Status</th><td><span class="badge bg-success">Completed</span></td></tr>' +
                '</table>';

            $('#reportDetailsContent').html(content);
            $('#detailsModal').modal('show');
        }

        function deleteReport(id) {
            const report = archivedReports.find(r => r.id === id);
            if (!report) return;

            if (confirm('Are you sure you want to delete ' + report.name + '?')) {
                showAlert('Report deleted successfully', 'success');
                // In a real app, remove from array and reload
                loadReports();
            }
        }

        function bulkDownloadReports() {
            if (selectedReports.length === 0) {
                showAlert('Please select reports to download', 'warning');
                return;
            }

            showAlert('Downloading ' + selectedReports.length + ' reports...', 'info');
            
            // Download each selected report
            selectedReports.forEach((reportId, index) => {
                setTimeout(() => {
                    downloadReport(reportId);
                }, index * 500); // Stagger downloads by 500ms
            });
            
            setTimeout(() => {
                showAlert('Bulk download complete! ' + selectedReports.length + ' files downloaded.', 'success');
                // Clear selections
                $('.report-checkbox').prop('checked', false);
                selectedReports = [];
            }, selectedReports.length * 500 + 500);
        }

        function bulkArchiveReports() {
            if (selectedReports.length === 0) {
                showAlert('Please select reports to archive', 'warning');
                return;
            }

            if (confirm('Archive ' + selectedReports.length + ' selected reports?')) {
                // Remove archived reports from the list
                selectedReports.forEach(id => {
                    const index = archivedReports.findIndex(r => r.id === id);
                    if (index > -1) {
                        archivedReports[index].status = 'archived';
                    }
                });
                
                showAlert(selectedReports.length + ' reports archived successfully', 'success');
                
                // Clear selections and reload
                $('.report-checkbox').prop('checked', false);
                selectedReports = [];
                loadReports();
            }
        }

        function bulkDeleteReports() {
            if (selectedReports.length === 0) {
                showAlert('Please select reports to delete', 'warning');
                return;
            }

            if (confirm('Are you sure you want to delete ' + selectedReports.length + ' selected reports? This action cannot be undone.')) {
                // Remove deleted reports from the array
                selectedReports.forEach(id => {
                    const index = archivedReports.findIndex(r => r.id === id);
                    if (index > -1) {
                        archivedReports.splice(index, 1);
                    }
                });
                
                showAlert('Reports deleted successfully', 'success');
                
                // Clear selections and reload
                $('.report-checkbox').prop('checked', false);
                selectedReports = [];
                loadReports();
                updateStats();
            }
        }

        // Helper functions
        function getReportTypeBadgeClass(type) {
            const classes = {
                'movement': 'bg-primary',
                'usage': 'bg-success',
                'compliance': 'bg-warning',
                'overdue': 'bg-danger',
                'department': 'bg-info',
                'user': 'bg-secondary',
                'audit': 'bg-dark',
                'summary': 'bg-purple'
            };
            return classes[type] || 'bg-secondary';
        }

        function getReportTypeIcon(type) {
            const icons = {
                'movement': 'fas fa-exchange-alt',
                'usage': 'fas fa-chart-line',
                'compliance': 'fas fa-shield-alt',
                'overdue': 'fas fa-exclamation-triangle',
                'department': 'fas fa-sitemap',
                'user': 'fas fa-users',
                'audit': 'fas fa-clipboard-check',
                'summary': 'fas fa-chart-pie'
            };
            return icons[type] || 'fas fa-file-alt';
        }

        function formatReportType(type) {
            const labels = {
                'movement': 'Movement',
                'usage': 'Usage',
                'compliance': 'Compliance',
                'overdue': 'Overdue',
                'department': 'Department',
                'user': 'User Activity',
                'audit': 'Audit Trail',
                'summary': 'Summary'
            };
            return labels[type] || type;
        }

        function getFormatIcon(format) {
            const icons = {
                'pdf': 'fas fa-file-pdf text-danger',
                'excel': 'fas fa-file-excel text-success',
                'csv': 'fas fa-file-csv text-info',
                'html': 'fas fa-file-code text-warning'
            };
            return icons[format] || 'fas fa-file';
        }
    </script>
</body>
</html>
